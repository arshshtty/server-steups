#!/bin/bash
# Nginx Reverse Proxy Manager
# Simple CLI tool to manage Nginx reverse proxy configurations
# Version: 1.0.0

set -euo pipefail

# Configuration
NGINX_SITES_AVAILABLE="${NGINX_SITES_AVAILABLE:-/etc/nginx/sites-available}"
NGINX_SITES_ENABLED="${NGINX_SITES_ENABLED:-/etc/nginx/sites-enabled}"
CONFIG_DIR="${CONFIG_DIR:-/etc/nginx-proxy}"
CONFIG_FILE="$CONFIG_DIR/proxies.json"
LOG_FILE="/var/log/nginx-proxy.log"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE" >&2
}

# Check if running as root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        log_error "This script must be run as root"
        exit 1
    fi
}

# Initialize config file
init_config() {
    if [ ! -d "$CONFIG_DIR" ]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [ ! -f "$CONFIG_FILE" ]; then
        echo '{}' > "$CONFIG_FILE"
        log_info "Created configuration file: $CONFIG_FILE"
    fi
}

# Validate domain name
validate_domain() {
    local domain="$1"
    if [[ ! "$domain" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$ ]]; then
        log_error "Invalid domain name: $domain"
        return 1
    fi
    return 0
}

# Validate backend
validate_backend() {
    local backend="$1"
    if [[ ! "$backend" =~ ^[a-zA-Z0-9.-]+:[0-9]+$ ]]; then
        log_error "Invalid backend format. Use: host:port (e.g., localhost:3000)"
        return 1
    fi
    return 0
}

# Add proxy configuration
add_proxy() {
    local domain="$1"
    local backend="$2"
    local enable_ssl="${3:-false}"
    local websocket="${4:-false}"

    validate_domain "$domain" || exit 1
    validate_backend "$backend" || exit 1

    log_info "Adding proxy configuration for $domain -> $backend"

    # Check if already exists
    if [ -f "$NGINX_SITES_AVAILABLE/$domain" ]; then
        log_warning "Configuration already exists for $domain"
        read -p "Overwrite? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "Aborted"
            exit 0
        fi
    fi

    # Create Nginx configuration
    cat > "$NGINX_SITES_AVAILABLE/$domain" <<EOF
# Reverse proxy configuration for $domain
# Generated by nginx-proxy on $(date)
# Backend: $backend

server {
    listen 80;
    server_name $domain;

    access_log /var/log/nginx/${domain}-access.log;
    error_log /var/log/nginx/${domain}-error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Proxy settings
    location / {
        proxy_pass http://$backend;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header X-Forwarded-Host \$host;
        proxy_set_header X-Forwarded-Port \$server_port;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
EOF

    if [ "$websocket" = "true" ]; then
        cat >> "$NGINX_SITES_AVAILABLE/$domain" <<EOF

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
EOF
    fi

    cat >> "$NGINX_SITES_AVAILABLE/$domain" <<EOF
    }
}
EOF

    # Store in config file
    local config_entry=$(cat <<EOF
{
  "domain": "$domain",
  "backend": "$backend",
  "ssl": $enable_ssl,
  "websocket": $websocket,
  "created": "$(date -Iseconds)",
  "enabled": true
}
EOF
)

    # Update JSON config (simple append-based approach)
    python3 -c "
import json
import sys

try:
    with open('$CONFIG_FILE', 'r') as f:
        data = json.load(f)
except:
    data = {}

data['$domain'] = $config_entry

with open('$CONFIG_FILE', 'w') as f:
    json.dump(data, f, indent=2)
" 2>/dev/null || echo "{\"$domain\": $config_entry}" > "$CONFIG_FILE"

    # Enable the site
    if [ ! -L "$NGINX_SITES_ENABLED/$domain" ]; then
        ln -sf "$NGINX_SITES_AVAILABLE/$domain" "$NGINX_SITES_ENABLED/$domain"
        log_info "Enabled site: $domain"
    fi

    # Test Nginx configuration
    if nginx -t 2>&1 | grep -q "successful"; then
        systemctl reload nginx
        log_success "Proxy added successfully: $domain -> $backend"
        log_info "Access your service at: http://$domain"

        if [ "$enable_ssl" = "true" ]; then
            log_info "Run 'nginx-proxy enable-ssl $domain' to enable HTTPS"
        fi
    else
        log_error "Nginx configuration test failed"
        rm -f "$NGINX_SITES_AVAILABLE/$domain"
        rm -f "$NGINX_SITES_ENABLED/$domain"
        exit 1
    fi
}

# Remove proxy configuration
remove_proxy() {
    local domain="$1"

    log_info "Removing proxy configuration for $domain"

    if [ ! -f "$NGINX_SITES_AVAILABLE/$domain" ]; then
        log_error "Configuration not found for $domain"
        exit 1
    fi

    # Disable the site
    if [ -L "$NGINX_SITES_ENABLED/$domain" ]; then
        rm -f "$NGINX_SITES_ENABLED/$domain"
        log_info "Disabled site: $domain"
    fi

    # Remove configuration file
    rm -f "$NGINX_SITES_AVAILABLE/$domain"

    # Remove from JSON config
    python3 -c "
import json

try:
    with open('$CONFIG_FILE', 'r') as f:
        data = json.load(f)

    if '$domain' in data:
        del data['$domain']

    with open('$CONFIG_FILE', 'w') as f:
        json.dump(data, f, indent=2)
except:
    pass
" 2>/dev/null

    # Reload Nginx
    systemctl reload nginx

    log_success "Proxy removed successfully: $domain"
}

# List all proxies
list_proxies() {
    log_info "Configured reverse proxies:"
    echo ""

    if [ ! -d "$NGINX_SITES_AVAILABLE" ]; then
        log_warning "No configurations found"
        return
    fi

    local count=0
    for config in "$NGINX_SITES_AVAILABLE"/*; do
        if [ -f "$config" ]; then
            local domain=$(basename "$config")

            # Skip default and other non-proxy configs
            if [[ "$domain" == "default" ]] || [[ "$domain" == "*.conf" ]]; then
                continue
            fi

            local backend=$(grep "proxy_pass" "$config" | head -1 | sed 's/.*proxy_pass \(.*\);/\1/' | sed 's/http:\/\///')
            local enabled="❌"
            local ssl="❌"

            if [ -L "$NGINX_SITES_ENABLED/$domain" ]; then
                enabled="✅"
            fi

            if grep -q "listen 443 ssl" "$config" 2>/dev/null; then
                ssl="✅"
            fi

            printf "%-30s %-25s SSL:%-3s Enabled:%-3s\n" "$domain" "$backend" "$ssl" "$enabled"
            count=$((count + 1))
        fi
    done

    echo ""
    log_info "Total: $count proxy configuration(s)"
}

# Enable SSL with Let's Encrypt
enable_ssl() {
    local domain="$1"
    local email="${2:-}"

    if [ ! -f "$NGINX_SITES_AVAILABLE/$domain" ]; then
        log_error "Configuration not found for $domain"
        exit 1
    fi

    # Check if certbot is installed
    if ! command -v certbot >/dev/null 2>&1; then
        log_error "Certbot is not installed. Install with: apt-get install certbot python3-certbot-nginx"
        exit 1
    fi

    log_info "Enabling SSL for $domain with Let's Encrypt"

    # Run certbot
    if [ -n "$email" ]; then
        certbot --nginx -d "$domain" --non-interactive --agree-tos --email "$email" --redirect
    else
        certbot --nginx -d "$domain"
    fi

    if [ $? -eq 0 ]; then
        log_success "SSL enabled successfully for $domain"
        log_info "Certificate will auto-renew via certbot timer"
    else
        log_error "Failed to enable SSL for $domain"
        exit 1
    fi
}

# Disable a proxy (keep config, just disable)
disable_proxy() {
    local domain="$1"

    if [ ! -L "$NGINX_SITES_ENABLED/$domain" ]; then
        log_warning "Proxy $domain is already disabled"
        exit 0
    fi

    rm -f "$NGINX_SITES_ENABLED/$domain"
    systemctl reload nginx

    log_success "Proxy disabled: $domain"
}

# Enable a proxy
enable_proxy() {
    local domain="$1"

    if [ ! -f "$NGINX_SITES_AVAILABLE/$domain" ]; then
        log_error "Configuration not found for $domain"
        exit 1
    fi

    if [ -L "$NGINX_SITES_ENABLED/$domain" ]; then
        log_warning "Proxy $domain is already enabled"
        exit 0
    fi

    ln -sf "$NGINX_SITES_AVAILABLE/$domain" "$NGINX_SITES_ENABLED/$domain"

    if nginx -t 2>&1 | grep -q "successful"; then
        systemctl reload nginx
        log_success "Proxy enabled: $domain"
    else
        log_error "Nginx configuration test failed"
        rm -f "$NGINX_SITES_ENABLED/$domain"
        exit 1
    fi
}

# Show help
show_help() {
    cat <<EOF
Nginx Reverse Proxy Manager - Simple CLI tool for managing reverse proxies

Usage: nginx-proxy <command> [options]

Commands:
    add <domain> <backend> [--ssl] [--websocket]
        Add a new reverse proxy configuration
        Example: nginx-proxy add app.example.com localhost:3000
        Example: nginx-proxy add api.example.com 192.168.1.100:8080 --websocket

    remove <domain>
        Remove a reverse proxy configuration
        Example: nginx-proxy remove app.example.com

    list
        List all configured reverse proxies

    enable-ssl <domain> [email]
        Enable SSL/TLS with Let's Encrypt for a domain
        Example: nginx-proxy enable-ssl app.example.com admin@example.com

    enable <domain>
        Enable a disabled proxy configuration
        Example: nginx-proxy enable app.example.com

    disable <domain>
        Disable a proxy configuration (without removing it)
        Example: nginx-proxy disable app.example.com

    status
        Show Nginx status

    test
        Test Nginx configuration

    reload
        Reload Nginx configuration

    help
        Show this help message

Options:
    --ssl           Enable SSL configuration (requires certbot)
    --websocket     Enable WebSocket support

Examples:
    # Add a simple HTTP reverse proxy
    nginx-proxy add myapp.com localhost:3000

    # Add a reverse proxy with WebSocket support
    nginx-proxy add chat.example.com localhost:8080 --websocket

    # Enable SSL with Let's Encrypt
    nginx-proxy enable-ssl myapp.com admin@example.com

    # List all configured proxies
    nginx-proxy list

    # Remove a proxy
    nginx-proxy remove myapp.com

Configuration:
    Config file: $CONFIG_FILE
    Nginx sites: $NGINX_SITES_AVAILABLE
    Log file: $LOG_FILE

EOF
}

# Show Nginx status
show_status() {
    systemctl status nginx --no-pager
}

# Test Nginx configuration
test_config() {
    log_info "Testing Nginx configuration..."
    nginx -t
}

# Reload Nginx
reload_nginx() {
    log_info "Reloading Nginx..."
    systemctl reload nginx
    log_success "Nginx reloaded successfully"
}

# Main function
main() {
    # Initialize
    init_config

    # Parse command
    local command="${1:-help}"

    case "$command" in
        add)
            check_root
            if [ $# -lt 3 ]; then
                log_error "Usage: nginx-proxy add <domain> <backend> [--ssl] [--websocket]"
                exit 1
            fi

            local domain="$2"
            local backend="$3"
            local ssl="false"
            local websocket="false"

            shift 3
            while [ $# -gt 0 ]; do
                case "$1" in
                    --ssl) ssl="true" ;;
                    --websocket) websocket="true" ;;
                    *) log_warning "Unknown option: $1" ;;
                esac
                shift
            done

            add_proxy "$domain" "$backend" "$ssl" "$websocket"
            ;;

        remove)
            check_root
            if [ $# -lt 2 ]; then
                log_error "Usage: nginx-proxy remove <domain>"
                exit 1
            fi
            remove_proxy "$2"
            ;;

        list)
            list_proxies
            ;;

        enable-ssl)
            check_root
            if [ $# -lt 2 ]; then
                log_error "Usage: nginx-proxy enable-ssl <domain> [email]"
                exit 1
            fi
            enable_ssl "$2" "${3:-}"
            ;;

        enable)
            check_root
            if [ $# -lt 2 ]; then
                log_error "Usage: nginx-proxy enable <domain>"
                exit 1
            fi
            enable_proxy "$2"
            ;;

        disable)
            check_root
            if [ $# -lt 2 ]; then
                log_error "Usage: nginx-proxy disable <domain>"
                exit 1
            fi
            disable_proxy "$2"
            ;;

        status)
            show_status
            ;;

        test)
            test_config
            ;;

        reload)
            check_root
            reload_nginx
            ;;

        help|--help|-h)
            show_help
            ;;

        *)
            log_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
